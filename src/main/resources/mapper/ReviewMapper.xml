<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="mapper.ReviewMapper">

    <!-- 목록 -->
    <select id="listByBook" resultType="map">
        SELECT
            r.review_id  AS "reviewId",
            r.user_id    AS "userId",
            u.name       AS "userName",
            r.content    AS "content",
            TO_CHAR(r.created_at, 'YYYY-MM-DD"T"HH24:MI:SS') AS "createdAt",
            CASE WHEN #{userId,jdbcType=BIGINT} IS NOT NULL AND r.user_id = #{userId,jdbcType=BIGINT}
                     THEN 1 ELSE 0 END AS "mine"
        FROM reviews r
                 JOIN users u ON u.user_id = r.user_id
        WHERE r.book_id = #{bookId,jdbcType=BIGINT}
        ORDER BY r.created_at DESC
    </select>

    <!-- 구매(배송완료) 여부 -->
    <select id="eligibilityCount" resultType="int">
        SELECT COUNT(*)
        FROM orders o
                 JOIN order_items oi ON oi.order_id = o.order_id
        WHERE o.user_id = #{userId,jdbcType=BIGINT}
          AND oi.book_id = #{bookId,jdbcType=BIGINT}
          AND UPPER(TRIM(o.status)) = 'DELIVERED'
    </select>

    <!-- 내 리뷰 존재 여부 -->
    <select id="hasMyReview" resultType="int">
        SELECT COUNT(*)
        FROM reviews
        WHERE user_id = #{userId,jdbcType=BIGINT}
          AND book_id = #{bookId,jdbcType=BIGINT}
    </select>

    <insert id="insert">
        INSERT INTO reviews (book_id, user_id, content, created_at)
        VALUES (#{bookId,jdbcType=BIGINT}, #{userId,jdbcType=BIGINT}, #{content,jdbcType=VARCHAR}, SYSTIMESTAMP)
    </insert>

    <!-- 본인 글만 수정 -->
    <update id="update">
        UPDATE reviews
        SET content = #{content,jdbcType=VARCHAR}
        WHERE review_id = #{reviewId,jdbcType=BIGINT}
          AND user_id   = #{userId,jdbcType=BIGINT}
    </update>

    <!-- 본인 글만 삭제 -->
    <delete id="delete">
        DELETE FROM reviews
        WHERE review_id = #{reviewId,jdbcType=BIGINT}
          AND user_id   = #{userId,jdbcType=BIGINT}
    </delete>
</mapper>
