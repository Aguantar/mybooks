<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="mapper.AdminOrderMapper">

    <!-- 목록 카운트 -->
    <select id="count" resultType="int">
        SELECT COUNT(*)
        FROM orders o
        JOIN users u ON u.user_id = o.user_id
        <where>
            <if test="q != null and q != ''">
                (
                TO_CHAR(o.order_id) LIKE '%' || #{q} || '%'
                OR LOWER(u.login_id) LIKE '%' || LOWER(#{q}) || '%'
                )
            </if>
            <if test="status != null and status != ''">
                AND o.status = #{status}
            </if>
        </where>
    </select>

    <!-- 목록 페이지 -->
    <select id="findPage" resultType="map">
        SELECT
        o.order_id      AS orderId,
        o.user_id       AS userId,
        u.login_id      AS loginId,
        o.status        AS status,
        o.total_amount  AS totalAmount
        FROM orders o
        JOIN users u ON u.user_id = o.user_id
        <where>
            <if test="q != null and q != ''">
                (
                TO_CHAR(o.order_id) LIKE '%' || #{q} || '%'
                OR LOWER(u.login_id) LIKE '%' || LOWER(#{q}) || '%'
                )
            </if>
            <if test="status != null and status != ''">
                AND o.status = #{status}
            </if>
        </where>
        ORDER BY o.order_id DESC
        OFFSET #{offset} ROWS FETCH NEXT #{size} ROWS ONLY
    </select>

    <!-- 상세(주문 요약) -->
    <select id="findOrder" resultType="map">
        SELECT
            o.order_id      AS orderId,
            o.user_id       AS userId,
            u.login_id      AS loginId,
            o.status        AS status,
            o.total_amount  AS totalAmount,
            o.address       AS address,
            o.postcode      AS postcode
        FROM orders o
                 JOIN users u ON u.user_id = o.user_id
        WHERE o.order_id = #{orderId}
    </select>

    <!-- 상세(품목 목록 + 책 정보) -->
    <select id="findItems" resultType="model.view.OrderItemView">
        SELECT
            oi.order_item_id AS orderItemId,
            oi.order_id      AS orderId,
            oi.book_id       AS bookId,
            oi.quantity      AS quantity,
            oi.unit_price    AS unitPrice,
            b.title          AS bookTitle,
            b.cover_image    AS coverImage
        FROM order_items oi
                 JOIN books b ON b.book_id = oi.book_id
        WHERE oi.order_id = #{orderId}
        ORDER BY oi.order_item_id
    </select>

    <!-- 상태 변경(현재상태 검증 옵션) -->
    <update id="updateStatus">
        UPDATE orders
        SET status = #{to}
        WHERE order_id = #{orderId}
        <if test="from != null and from != ''">
            AND status = #{from}
        </if>
    </update>
</mapper>
